steps:
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    # 安裝 SSH 客戶端
    apt-get update && apt-get install -y openssh-client

    # 從 Secret Manager 獲取 SSH 私鑰
    gcloud secrets versions access latest --secret=ssh-key > /root/.ssh/id_rsa

    # 設置正確的權限
    chmod 600 /root/.ssh/id_rsa

    # 添加 SSH 密鑰到 known_hosts
    mkdir -p /root/.ssh
    ssh-keyscan -H 35.201.224.207 >> /root/.ssh/known_hosts

    # 使用 SSH 連接到虛擬機並創建文件
    ssh -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no lucifer_suriel@35.201.224.207 "touch /home/lucifer_suriel/test_file.txt"

timeout: '600s'
options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
